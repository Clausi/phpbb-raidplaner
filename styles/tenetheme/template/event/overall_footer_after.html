<!-- IF S_CLAUSI_RAIDPLANER_ACTIVE -->

<!-- INCLUDEJS jquery-ui/jquery-ui.min.js -->
<!-- INCLUDEJS raidplaner.js -->

<script type="text/javascript">
$(document).ready(function() {
	
	<!-- IF RAIDPLANER_INDEX -->
	function filterTable(table, filter) {
		if(filter == 0) table.fnFilter( '' , 0, false);
		else table.fnFilter("^"+filter+"$", 0, true);
	}
	
	$('table.clickable_row').on('click', 'tbody > tr > td', function() {
		if($(this).attr('class') != 'no_click') location.href = $(this).parent('tr').data('url');
	});
	
	var raidplanerTable = $('#datatables-raidplaner').dataTable( {
		"oLanguage": {
			<!-- IF S_USER_LANG == 'de' -->"sUrl": "{T_THEME_PATH}/libs/datatables/lang/dataTables.german.txt"<!-- ENDIF -->
		},
		"order": [[ 2, "asc" ]],
		"pageLength": 10,
		"lengthMenu": [[ 10, 15, 25, 50, 100, -1], [ 10, 15, 25, 50, 100, "{L_ALL}"] ],
		
		"columnDefs": [
		  { "targets": 0, "visible": false },
		  { "targets": 1, "visible": false },
		  { "orderData": [3,2], "targets": 2 },
		  { "targets": 3, "visible": false },
		  { "targets": 5, "orderable": false },
		  { "targets": 6, "orderable": false },
		  { "targets": 7, "orderable": false },
		],
		
		"fnInitComplete": function(oSettings, json) {
			filterTable(this, "future");
			createSelectpicker();
		}
	});
	
	$('select#raidplanerFilter').on('change',function(){
        var selectedValue = $(this).val();
		  filterTable(raidplanerTable, selectedValue);
	});
	<!-- ENDIF -->

	<!-- IF U_RAIDPLANER -->
	
	$('.raidplaner-comment').popover({
		placement: 'top',
		trigger: 'hover',
	});

	$("table.checkboxes").on('change', "input[id^=status_]", function(e){
		$("#statuslabel_"+this.id.split('_')[1]).toggleClass("fa-square-o fa-check-square-o");
	});

	var lang_status = {
		0: '{L_NOT_SIGNUP}',
		1: '{L_ATTENDING}',
		2: '{L_DECLINE}',
		3: '{L_SUBSTITUTE}',
		4: '{L_ACCEPT}'
	};
	var icon = {
		0: 'minus',
		1: 'circle',
		2: 'times',
		3: 'minus',
		4: 'check'
	};
	phpbb.addAjaxCallback('raidplaner_status', function(res) {
		$(this).parent('div.btn-group');
		$('#btn_' + res.RAID_ID).removeClass('btn-danger btn-warning btn-success btn-default');
		var newClass = '';
		switch(res.STATUS_ID) {
		 case '1':
			  newClass = 'btn-default';
		 break;
		 case '2':
			  newClass = 'btn-danger';
		 break;
		case '3':
			  newClass = 'btn-warning';
		 break;
		 default:
			  newClass = 'btn-default';
		}
		
		$('#btn_' + res.RAID_ID).addClass(newClass).html('<i class="fa fa-'+ icon[res.STATUS_ID] +'"></i> ' + lang_status[res.STATUS_ID] + ' <span class="caret"></span>');
		$('#decline_' + res.RAID_ID).text(res.DECLINE);
		$('#substitute_' + res.RAID_ID).text(res.SUBSTITUTE);
		$('#attending_' + res.RAID_ID).text(res.ATTENDING);
		
		$('ul#' + res.STATUSNAME + res.ROLENAME + 'View').append($('li#user_' + res.USER_ID));
		$('ul#' + res.STATUSNAME + res.ROLENAME + 'View').removeClass('emptyList');
		if($('ul#' + res.OLD_STATUSNAME + res.OLD_ROLENAME + 'View').children('li').length === 0) $('ul#' + res.OLD_STATUSNAME + res.OLD_ROLENAME + 'View').addClass('emptyList');
		
		raidplanerView.sortable( 'refresh' );

	});
	
	<!-- ENDIF -->
	
	<!-- IF M_RAIDPLANER -->
	var raidplanerView = $( "<!-- BEGIN n_status --><!-- BEGIN n_roles -->#{n_status.STATUSNAME}{n_status.n_roles.ROLENAME}View<!-- IF n_status.n_roles.LASTELEMENT == false -->, <!-- ENDIF --><!-- END n_roles --><!-- END n_status -->" );
	raidplanerView.sortable({
		connectWith: ".connectedSortable",
		placeholder: "list-group-item list-group-item-warning placeholder",
		receive: function (e, ui) {
			if($(e.target).children('li').length > 0) $(e.target).removeClass('emptyList');
		},
		remove: function(e, ui) {
			if($(e.target).children('li').length === 0) $(e.target).addClass('emptyList');
		},
		out: function(e, ui) {
			if (this === ui.item.parent()[0]) {
				if($(e.target).children('li').length === 2) $(e.target).addClass('emptyList');
			}
		},
		update: function (e, ui) {
			if (this === ui.item.parent()[0]) {
				var data = "user_id=" + ui.item.context.id.replace("user_", "") + "&status_id=" + e.target.dataset.status + "&role_id=" + e.target.dataset.role;
				$.ajax({
					data: data,
					type: 'POST',
					url: '{U_MODSTATUSCHANGE}'
				});
			}
		}
	}).disableSelection();
	<!-- ENDIF -->

});

</script>
<!-- ENDIF -->
